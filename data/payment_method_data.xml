<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <!-- Payment Icons -->
        <record id="payment_icon_vipps" model="payment.icon">
            <field name="name">Vipps</field>
            <field name="image" type="base64" file="mobilepay_vipps/static/src/img/vipps_icon.png"/>
        </record>
        
        <record id="payment_icon_mobilepay" model="payment.icon">
            <field name="name">MobilePay</field>
            <field name="image" type="base64" file="mobilepay_vipps/static/src/img/mobilepay_icon.png"/>
        </record>
        
        <!-- Default Payment Provider (disabled by default) -->
        <record id="payment_provider_vipps_mobilepay" model="payment.provider">
            <field name="name">Vipps/MobilePay</field>
            <field name="code">vipps_mobilepay</field>
            <field name="state">disabled</field>
            <field name="is_published">False</field>
            <field name="payment_icon_ids" eval="[(6, 0, [ref('payment_icon_vipps'), ref('payment_icon_mobilepay')])]"/>
            <field name="allow_tokenization">False</field>
            <field name="capture_manually">False</field>
            <field name="allow_express_checkout">True</field>
            <field name="redirect_form_view_id" ref="redirect_form"/>
            <field name="inline_form_view_id" ref="inline_form"/>
            <field name="token_inline_form_view_id" ref="token_form"/>
            <field name="fees_active">False</field>
            <field name="support_manual_capture">True</field>
            <field name="support_refund">partial</field>
            <field name="support_tokenization">False</field>
            <field name="module_id" ref="base.module_payment_vipps_mobilepay"/>
            <field name="module_state">installed</field>
            <field name="image_128" type="base64" file="mobilepay_vipps/static/description/icon.png"/>
        </record>
        
        <!-- Default Configuration Values -->
        <record id="vipps_config_defaults" model="ir.config_parameter">
            <field name="key">payment_vipps_mobilepay.default_environment</field>
            <field name="value">test</field>
        </record>
        
        <record id="vipps_webhook_timeout" model="ir.config_parameter">
            <field name="key">payment_vipps_mobilepay.webhook_timeout</field>
            <field name="value">30</field>
        </record>
        
        <record id="vipps_api_timeout" model="ir.config_parameter">
            <field name="key">payment_vipps_mobilepay.api_timeout</field>
            <field name="value">30</field>
        </record>
        
        <record id="vipps_max_retries" model="ir.config_parameter">
            <field name="key">payment_vipps_mobilepay.max_retries</field>
            <field name="value">3</field>
        </record>
        
        <!-- Default Profile Scopes -->
        <record id="profile_scope_name" model="vipps.profile.scope">
            <field name="name">name</field>
            <field name="description">User's full name</field>
            <field name="required">False</field>
            <field name="sensitive">False</field>
        </record>
        
        <record id="profile_scope_email" model="vipps.profile.scope">
            <field name="name">email</field>
            <field name="description">User's email address</field>
            <field name="required">False</field>
            <field name="sensitive">True</field>
        </record>
        
        <record id="profile_scope_phone" model="vipps.profile.scope">
            <field name="name">phoneNumber</field>
            <field name="description">User's phone number</field>
            <field name="required">False</field>
            <field name="sensitive">True</field>
        </record>
        
        <record id="profile_scope_address" model="vipps.profile.scope">
            <field name="name">address</field>
            <field name="description">User's address information</field>
            <field name="required">False</field>
            <field name="sensitive">True</field>
        </record>
        
        <record id="profile_scope_birthdate" model="vipps.profile.scope">
            <field name="name">birthDate</field>
            <field name="description">User's birth date</field>
            <field name="required">False</field>
            <field name="sensitive">True</field>
        </record>
        
        <!-- Cron Jobs -->
        <record id="cron_cleanup_expired_tokens" model="ir.cron">
            <field name="name">Vipps: Cleanup Expired Access Tokens</field>
            <field name="model_id" ref="payment.model_payment_provider"/>
            <field name="state">code</field>
            <field name="code">
                providers = model.search([('code', '=', 'vipps_mobilepay')])
                for provider in providers:
                    provider._cleanup_expired_tokens()
            </field>
            <field name="interval_number">1</field>
            <field name="interval_type">hours</field>
            <field name="numbercall">-1</field>
            <field name="active">True</field>
            <field name="doall">False</field>
        </record>
        
        <record id="cron_cleanup_old_transactions" model="ir.cron">
            <field name="name">Vipps: Cleanup Old Transaction Data</field>
            <field name="model_id" ref="model_vipps_data_management"/>
            <field name="state">code</field>
            <field name="code">
                data_mgmt = model.search([], limit=1)
                if data_mgmt:
                    data_mgmt.cleanup_expired_data()
            </field>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field>
            <field name="active">True</field>
            <field name="doall">False</field>
        </record>
        
        <!-- Server Actions -->
        <record id="action_validate_vipps_config" model="ir.actions.server">
            <field name="name">Validate Vipps Configuration</field>
            <field name="model_id" ref="payment.model_payment_provider"/>
            <field name="binding_model_id" ref="payment.model_payment_provider"/>
            <field name="state">code</field>
            <field name="code">
                for record in records:
                    if record.code == 'vipps_mobilepay':
                        result = record.vipps_validate_credentials()
                        if result.get('success'):
                            record.message_post(body="Vipps credentials validated successfully")
                        else:
                            record.message_post(body=f"Vipps credential validation failed: {result.get('error', 'Unknown error')}")
            </field>
        </record>
        
        <record id="action_test_vipps_webhook" model="ir.actions.server">
            <field name="name">Test Vipps Webhook</field>
            <field name="model_id" ref="payment.model_payment_provider"/>
            <field name="binding_model_id" ref="payment.model_payment_provider"/>
            <field name="state">code</field>
            <field name="code">
                for record in records:
                    if record.code == 'vipps_mobilepay':
                        result = record.vipps_test_webhook()
                        if result.get('success'):
                            record.message_post(body="Webhook test successful")
                        else:
                            record.message_post(body=f"Webhook test failed: {result.get('error', 'Unknown error')}")
            </field>
        </record>
        
    </data>
</odoo>