# Webhook Signature Error - Root Cause Analysis

## üîç **The Problem**

```
Signature mismatch - Expected: UGf8HlA8WLe5jqfZGKIwBRo+UTQ3IQ5jX9etuSSiv9Q=
Got: LEe/3UV1HYKRNdacyGJUeRHFwyIGgtWv13O9yZ9khvo=
Secret bytes length: 88
```

## üéØ **Root Cause**

The webhook secret stored in Odoo **does not match** the secret Vipps is using to sign webhooks.

## üìã **How Vipps Webhooks Work**

### **Step 1: Register Webhook (One Time)**
```
POST /webhooks/v1/webhooks
{
  "url": "https://your-domain.com/payment/vipps/webhook",
  "events": ["epayments.payment.created.v1", ...]
}

Response:
{
  "id": "webhook-id-123",
  "secret": "base64-encoded-secret-from-vipps"  ‚Üê THIS IS THE KEY!
}
```

### **Step 2: Create Payment (Per Payment)**
```
POST /epayment/v1/payments
{
  "reference": "ORDER-123",
  "callbackPrefix": "https://your-domain.com/payment/vipps",
  "merchantInfo": {
    "callbackAuthorizationToken": "your-token"  ‚Üê NOT USED FOR SIGNING!
  }
}
```

### **Step 3: Vipps Sends Webhook**
```
Vipps signs webhook using the SECRET from Step 1
NOT the callbackAuthorizationToken from Step 2!
```

## ‚ö†Ô∏è **The Mismatch**

Your code is:
1. ‚úÖ Registering webhook correctly
2. ‚ùå **But the secret from Vipps response is not being stored/used correctly**
3. ‚ùå Or the webhook was never registered successfully
4. ‚ùå Or using an old/wrong secret

## üîß **Why Secret Length is 88**

```
Secret bytes length: 88
```

This suggests:
- Base64-encoded 64-byte secret = 88 characters
- This is a valid Vipps webhook secret format
- **BUT** it's not the same secret Vipps is currently using

## üéØ **Possible Causes**

### **1. Webhook Never Registered**
- Secret was generated locally but never sent to/received from Vipps
- Vipps is using a different secret

### **2. Webhook Re-registered Without Updating Secret**
- Webhook was re-registered in Vipps portal
- New secret generated by Vipps
- Old secret still in Odoo database

### **3. Environment Mismatch**
- Using test environment secret with production webhooks
- Or vice versa

### **4. Multiple Webhooks**
- Multiple webhooks registered for same URL
- Vipps using secret from different webhook registration

## ‚úÖ **The Solution**

### **Option 1: Re-register Webhook (Recommended)**

1. **In Odoo**: Click "Re-register Webhook (New Secret)" button
2. **Watch logs** for webhook registration response
3. **Verify** secret is stored: Check `provider.vipps_webhook_secret`
4. **Test** a new payment
5. **Confirm** signature validation passes

### **Option 2: Manual Verification**

1. **Check Vipps Portal**: List registered webhooks
2. **Get webhook ID**: Note the ID for your URL
3. **In Odoo**: Verify `vipps_webhook_id` matches
4. **If mismatch**: Delete webhook in portal, re-register from Odoo

### **Option 3: Debug Registration**

Run the diagnostic script:
```bash
python3 odoo-bin shell -d your_database
# Then run check_webhook_secret.py code
```

## üìä **Expected vs Actual**

### **What Should Happen**
```
1. Register webhook ‚Üí Get secret from Vipps
2. Store secret in Odoo
3. Vipps signs webhooks with that secret
4. Odoo validates using same secret
5. ‚úÖ Signatures match!
```

### **What's Happening**
```
1. Register webhook ‚Üí Get secret from Vipps (maybe?)
2. Store secret in Odoo (maybe wrong one?)
3. Vipps signs webhooks with their secret
4. Odoo validates using different secret
5. ‚ùå Signatures don't match!
```

## üîç **Diagnostic Steps**

### **1. Check Current Secret**
```python
provider = env['payment.provider'].search([('code', '=', 'vipps')], limit=1)
print(f"Secret length: {len(provider.vipps_webhook_secret_decrypted)}")
print(f"Webhook ID: {provider.vipps_webhook_id}")
```

### **2. Check Webhook Registration Logs**
Look for:
```
‚úÖ DEBUG: Webhook registration successful
‚úÖ DEBUG: Response: {'id': '...', 'secret': '...'}
‚úÖ DEBUG: Stored webhook secret: Yes
```

### **3. Verify in Vipps Portal**
- Go to Vipps/MobilePay developer portal
- Check registered webhooks
- Verify URL matches
- Note the webhook ID

## üöÄ **Quick Fix**

The fastest solution:

1. **Click** "Re-register Webhook (New Secret)" in Odoo
2. **Wait** for success message
3. **Test** a new payment
4. **Check** logs for signature validation

This will:
- Delete old webhook
- Register new webhook
- Get fresh secret from Vipps
- Store it correctly
- Sync everything

## ‚úÖ **Success Indicators**

After re-registering, you should see:
```
‚úÖ No signature mismatch warnings
‚úÖ Webhook validation passes
‚úÖ Payments process correctly
‚úÖ Logs show: "Signature validation result: {'valid': True}"
```

## üìù **Summary**

**Problem**: Webhook secret mismatch  
**Cause**: Secret in Odoo ‚â† Secret Vipps is using  
**Solution**: Re-register webhook to sync secrets  
**Action**: Click "Re-register Webhook (New Secret)" button  
**Result**: Signatures will match ‚úÖ