<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vipps/MobilePay Compliant Payment Flow Template -->
        <template id="vipps_redirect_form" name="Vipps/MobilePay Payment Flow">
            <div class="vipps-payment-container" data-transaction-id="{{transaction_id}}" data-api-url="{{api_url}}">
                <div class="card">
                    <div class="card-body text-center">
                        <div id="vipps-payment-status">
                            <h4>Complete your payment</h4>
                            <p>Click the button below to pay with Vipps/MobilePay</p>
                            <t t-if="api_url">
                                <a t-att-href="api_url" 
                                   class="btn btn-primary btn-lg" 
                                   id="vipps-pay-button"
                                   target="_blank"
                                   rel="noopener">
                                    <i class="fa fa-mobile"></i> Pay with Vipps/MobilePay
                                </a>
                            </t>
                            <div class="mt-3">
                                <small class="text-muted">A new window will open for payment</small>
                            </div>
                        </div>
                        
                        <div id="vipps-waiting-status" style="display: none;">
                            <h4>Waiting for payment confirmation...</h4>
                            <p>Please complete your payment in the Vipps/MobilePay window</p>
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Processing payment...</span>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">This page will update automatically when payment is complete</small>
                            </div>
                        </div>
                        
                        <div id="vipps-success-status" style="display: none;">
                            <h4 class="text-success">Payment Successful!</h4>
                            <p>Your payment has been processed successfully</p>
                            <i class="fa fa-check-circle fa-3x text-success"></i>
                        </div>
                        
                        <div id="vipps-error-status" style="display: none;">
                            <h4 class="text-danger">Payment Failed</h4>
                            <p>There was an issue processing your payment</p>
                            <i class="fa fa-times-circle fa-3x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <script type="text/javascript">
                // Vipps-compliant payment flow implementation
                (function() {
                    var container = document.querySelector('.vipps-payment-container');
                    if (!container) return;
                    
                    var transactionId = container.dataset.transactionId;
                    var payButton = document.getElementById('vipps-pay-button');
                    var initialStatus = document.getElementById('vipps-payment-status');
                    var waitingStatus = document.getElementById('vipps-waiting-status');
                    var successStatus = document.getElementById('vipps-success-status');
                    var errorStatus = document.getElementById('vipps-error-status');
                    
                    var pollInterval;
                    var paymentWindow;
                    
                    // Handle payment button click
                    if (payButton) {
                        payButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Open payment window
                            paymentWindow = window.open(
                                payButton.href, 
                                'vipps_payment', 
                                'width=400,height=600,scrollbars=yes,resizable=yes'
                            );
                            
                            // Switch to waiting status
                            initialStatus.style.display = 'none';
                            waitingStatus.style.display = 'block';
                            
                            // Start polling for payment status
                            startStatusPolling();
                        });
                    }
                    
                    function startStatusPolling() {
                        pollInterval = setInterval(function() {
                            checkPaymentStatus();
                        }, 2000); // Poll every 2 seconds
                        
                        // Stop polling after 10 minutes
                        setTimeout(function() {
                            if (pollInterval) {
                                clearInterval(pollInterval);
                                showError('Payment timeout - please try again');
                            }
                        }, 600000);
                    }
                    
                    function checkPaymentStatus() {
                        fetch('/payment/vipps/status/' + transactionId, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'done') {
                                showSuccess();
                                if (paymentWindow) paymentWindow.close();
                                // Redirect to success page after 2 seconds
                                setTimeout(function() {
                                    window.location.href = data.redirect_url || '/shop/payment/validate';
                                }, 2000);
                            } else if (data.status === 'error' || data.status === 'cancel') {
                                showError(data.message || 'Payment failed');
                                if (paymentWindow) paymentWindow.close();
                            }
                            // Continue polling for pending status
                        })
                        .catch(error => {
                            console.error('Error checking payment status:', error);
                        });
                    }
                    
                    function showSuccess() {
                        clearInterval(pollInterval);
                        waitingStatus.style.display = 'none';
                        successStatus.style.display = 'block';
                    }
                    
                    function showError(message) {
                        clearInterval(pollInterval);
                        waitingStatus.style.display = 'none';
                        errorStatus.style.display = 'block';
                        if (message) {
                            errorStatus.querySelector('p').textContent = message;
                        }
                    }
                    
                    // Handle payment window close
                    window.addEventListener('beforeunload', function() {
                        if (pollInterval) clearInterval(pollInterval);
                        if (paymentWindow) paymentWindow.close();
                    });
                })();
            </script>
        </template>
    </data>
</odoo>