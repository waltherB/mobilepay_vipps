<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Payment Transaction Form View Extension -->
    <record id="view_payment_transaction_form_vipps" model="ir.ui.view">
        <field name="name">payment.transaction.form.vipps</field>
        <field name="model">payment.transaction</field>
        <field name="inherit_id" ref="payment.payment_transaction_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="inside">
                <div class="oe_button_box" name="button_box" attrs="{'invisible': [('provider_code', '!=', 'vipps')]}">
                    <button name="action_view_user_information" 
                            type="object" 
                            class="oe_stat_button" 
                            icon="fa-user"
                            attrs="{'invisible': [('vipps_user_details', '=', False)]}">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_text">User Info</span>
                        </div>
                    </button>
                </div>
            </xpath>
            
            <xpath expr="//group[@name='payment_details']" position="after">
                <group string="Vipps Details" attrs="{'invisible': [('provider_code', '!=', 'vipps')]}">
                    <group>
                        <field name="vipps_payment_reference" readonly="1"/>
                        <field name="vipps_psp_reference" readonly="1"/>
                        <field name="vipps_payment_state" readonly="1"/>
                        <field name="vipps_user_flow" readonly="1"/>
                    </group>
                    <group>
                        <field name="vipps_pos_method" readonly="1"/>
                        <field name="vipps_user_sub" readonly="1" groups="base.group_system"/>
                        <field name="vipps_idempotency_key" readonly="1" groups="base.group_system"/>
                    </group>
                </group>
                
                <group string="User Information" 
                       attrs="{'invisible': ['|', ('provider_code', '!=', 'vipps'), ('vipps_user_details', '=', False)]}">
                    <div class="alert alert-info" role="alert">
                        <strong>User Information Collected:</strong> This transaction includes customer data 
                        collected with consent during the payment process. 
                        <button name="action_view_user_information" 
                                type="object" 
                                class="btn btn-link p-0"
                                string="View Details"/>
                    </div>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Payment Transaction Tree View Extension -->
    <record id="view_payment_transaction_tree_vipps" model="ir.ui.view">
        <field name="name">payment.transaction.tree.vipps</field>
        <field name="model">payment.transaction</field>
        <field name="inherit_id" ref="payment.payment_transaction_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="vipps_payment_state" optional="hide"/>
                <field name="vipps_user_details" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Payment Transaction Search View Extension -->
    <record id="view_payment_transaction_search_vipps" model="ir.ui.view">
        <field name="name">payment.transaction.search.vipps</field>
        <field name="model">payment.transaction</field>
        <field name="inherit_id" ref="payment.payment_transaction_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='done']" position="after">
                <separator/>
                <filter name="vipps_transactions" 
                        string="Vipps Transactions" 
                        domain="[('provider_code', '=', 'vipps')]"/>
                <filter name="vipps_with_user_data" 
                        string="Has User Data" 
                        domain="[('provider_code', '=', 'vipps'), ('vipps_user_details', '!=', False)]"/>
            </xpath>
            <xpath expr="//group[@name='group_by']" position="inside">
                <filter name="group_by_vipps_state" 
                        string="Vipps State" 
                        context="{'group_by': 'vipps_payment_state'}"/>
                <filter name="group_by_vipps_flow" 
                        string="User Flow" 
                        context="{'group_by': 'vipps_user_flow'}"/>
            </xpath>
        </field>
    </record>

</odoo>